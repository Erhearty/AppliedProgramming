extends layout

block title
  title Список задач

block content
  h2 Ваші задачі
  form#addForm
    input#titleInput(type="text" name="title" placeholder="Введіть назву задачі" required minlength="3" maxlength="100")
    button(type="submit") Додати

  hr

  ul#tasksList

  script.
    const notyf = new Notyf();
    // Перевіряємо токен
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
    }

    // Load tasks
    async function loadTasks() {
      const res = await fetch('/api/tasks', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      if (!res.ok) {
        notyf.error("Необхідний вхід");
        setTimeout(() => window.location.href = '/login', 800);
        return;
      }

      const tasks = await res.json();

      const list = document.getElementById('tasksList');
      list.innerHTML = "";

      tasks.forEach(t => {
        const li = document.createElement('li');
        li.dataset.id = t._id;

        li.innerHTML = `
          ${t.completed ? `<del>${t.title}</del>` : t.title}
          &nbsp;
          <button class="btn-toggle" data-id="${t._id}">Toggle</button>
          <button class="btn-delete" data-id="${t._id}">Delete</button>
        `;

        list.appendChild(li);
      });
    }

    loadTasks();

    async function handleFetch(url, options = {}) {
      options.headers ??= {};
      options.headers['Content-Type'] = 'application/json';
      options.headers['Authorization'] = 'Bearer ' + token;

      try {
        const res = await fetch(url, options);

        let data = {};
        try { data = await res.json(); } catch {}

        if (res.status >= 200 && res.status < 300) {
          notyf.success(data.message || 'Успішно');
          return data;
        } else {
          notyf.error(data.error || `Помилка ${res.status}`);
          return null;
        }
      } catch (err) {
        notyf.error("Помилка мережі");
        return null;
      }
    }

    // Додавання задачі
    const form = document.getElementById('addForm');
    const titleInput = document.getElementById('titleInput');
    const tasksList = document.getElementById('tasksList');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = titleInput.value.trim();
      if (!title) return;

      const data = await handleFetch('/api/tasks', {
        method: 'POST',
        body: JSON.stringify({ title })
      });

      if (data) {
        loadTasks();
        titleInput.value = '';
      }
    });

    // Toggle і Delete
    tasksList.addEventListener('click', async (e) => {
      const target = e.target;
      const id = target.dataset.id;

      if (!id) return;

      // Toggle
      if (target.classList.contains('btn-toggle')) {
        await handleFetch(`/api/tasks/${id}`, { method: 'PUT' });
        loadTasks();
      }

      // Delete
      if (target.classList.contains('btn-delete')) {
        if (!confirm('Видалити задачу?')) return;

        const data = await handleFetch(`/api/tasks/${id}`, { method: 'DELETE' });
        if (data) {
          loadTasks();
        }
      }
    });
